<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task-level Anomaly Explorer</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --muted:#9fb0d0;
      --text:#eaf0ff;
      --accent:#7aa2ff;
      --border:rgba(255,255,255,.12);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#070b17,#0b1020);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px;}
    h1{font-size:22px;margin:0 0 6px}
    p{margin:0 0 14px;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select,input{
      background:rgba(0,0,0,.25);
      color:var(--text);
      border:1px solid var(--border);
      padding:10px 10px;
      border-radius:10px;
      font-size:14px;
      outline:none
    }
    input{min-width:220px}
    button,a.btn{
      background:rgba(122,162,255,.15);
      color:var(--text);
      border:1px solid rgba(122,162,255,.35);
      padding:10px 12px;
      border-radius:10px;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-block
    }
    button:hover,a.btn:hover{background:rgba(122,162,255,.22)}
    button:disabled{opacity:.45; cursor:not-allowed;}
    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted)
    }
    .status{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
      font-size:14px
    }
    th{
      color:var(--muted);
      text-align:left;
      cursor:pointer;
      user-select:none
    }
    tr:hover{background:rgba(255,255,255,.03)}
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px
    }
    details{margin-top:6px}
    details summary{cursor:pointer;color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .err{color:#ff8f8f}
    .ok{color:#a8ffb0}

    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      margin:2px 6px 2px 0;
      color:var(--text);
      background:rgba(0,0,0,.20);
      white-space:nowrap;
    }
    .label-invariant{border-color:rgba(168,255,176,.35); background:rgba(168,255,176,.10);}
    .label-specific{border-color:rgba(122,162,255,.45); background:rgba(122,162,255,.12);}
    .label-inconsistent{border-color:rgba(255,143,143,.45); background:rgba(255,143,143,.10);}
    .label-insufficient{border-color:rgba(255,255,255,.22); background:rgba(255,255,255,.06);}

    .helpbox{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px;
      background:rgba(0,0,0,.12);
    }
    .helpbox .small{margin:0; line-height:1.45}
    .helpbox b{color:var(--text); font-weight:600}

    footer{
      margin-top:32px;
      padding:18px 20px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    footer strong{color:var(--text);font-weight:600;}
    footer a{color:var(--accent);text-decoration:none;}
    footer a:hover{text-decoration:underline;}
    .affiliation{margin-top:6px;font-size:12px;opacity:0.9;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Task-level Anomaly Explorer</h1>
    <p>
      Interactive viewer for per-task anomaly scores + SML outputs (static, GitHub Pages-friendly).
      <span class="small">Per-task viewer loads <span class="mono">outputs/&lt;task&gt;_anomaly_scores.csv</span> and optional
      <span class="mono">outputs/&lt;task&gt;_anomaly_explanations.csv</span>.</span>
    </p>

    <div class="grid">

      <!-- Controls -->
      <div class="card">
        <div class="row">
          <div>
            <label for="task">Task</label><br/>
            <select id="task">
              <option value="stand">stand</option>
              <option value="chair">chair</option>
              <option value="wheelchair">wheelchair</option>
              <option value="sit">sit</option>
              <option value="stand-frame">stand-frame</option>
            </select>
          </div>

          <div>
            <label for="topn">Top N</label><br/>
            <select id="topn">
              <option>10</option>
              <option selected>20</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>

          <div>
            <label for="q">Search (subject id / path)</label><br/>
            <input id="q" placeholder="e.g., 207 or 202_18_3" />
          </div>

          <div style="margin-left:auto" class="row">
            <button id="reload">Reload</button>
            <a class="btn" id="download" href="#" download>Download table (CSV)</a>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="filesBadge">rows: —</span>
          <span class="pill" id="rangeBadge">score01: —</span>
          <span class="status" id="status">Ready.</span>
        </div>
      </div>

      <!-- Per-task table -->
      <div class="card">
        <div class="small">
          Expects these files (relative paths):
          <div class="mono">outputs/&lt;task&gt;_anomaly_scores.csv</div>
          <div class="mono">outputs/&lt;task&gt;_anomaly_explanations.csv</div>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th data-k="rank">Rank</th>
              <th data-k="score01">Score01</th>
              <th data-k="mahalanobis_sq">Mahalanobis²</th>
              <th data-k="subject_id">Subject</th>
              <th data-k="path">Path</th>
              <th data-k="explanation">Explanation</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="small" style="margin-top:10px">
          Tip: click on table headers to sort. Explanations are shown if present in explanations CSV.
        </div>
      </div>

      <!-- Cross-task consistency auditor -->
      <div class="card">
        <div class="row">
          <div style="min-width:280px">
            <div style="font-size:15px; font-weight:600;">Cross-task Consistency (SML Auditor)</div>
            <div class="small">
              Loads <span class="mono">outputs/consistency_labels.csv</span> (generated by <span class="mono">python explain_anomalies.py audit ...</span>)
            </div>
          </div>

          <div>
            <label for="cq">Search subject</label><br/>
            <input id="cq" placeholder="e.g., 207" />
          </div>

          <!-- Label filter -->
          <div>
            <label for="clabel">Filter label</label><br/>
            <select id="clabel">
              <option value="all" selected>All labels</option>
              <option value="task_invariant">task_invariant</option>
              <option value="task_specific">task_specific</option>
              <option value="inconsistent">inconsistent</option>
              <option value="insufficient_tasks">insufficient_tasks</option>
            </select>
          </div>

          <div>
            <label for="climit">Show</label><br/>
            <select id="climit">
              <option selected>20</option>
              <option>50</option>
              <option>100</option>
              <option>500</option>
            </select>
          </div>

          <div style="margin-left:auto" class="row">
            <button id="creload">Reload Consistency</button>
            <a class="btn" id="cdownload" href="#" download>Download labels (CSV)</a>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="cfilesBadge">rows: —</span>
          <span class="status" id="cstatus">Ready.</span>
        </div>

        <div class="helpbox">
          <p class="small">
            <b>Labels:</b><br/>
            • <span class="tag label-invariant">task_invariant</span> παρόμοιες οικογένειες/χαρακτηριστικά ανωμαλίας εμφανίζονται σε <b>≥2 tasks</b><br/>
            • <span class="tag label-specific">task_specific</span> ανωμαλίες κυρίως σε <b>ένα task</b> (ή καθαρό υποσύνολο tasks)<br/>
            • <span class="tag label-inconsistent">inconsistent</span> αλλάζουν τελείως από task σε task χωρίς σταθερό μοτίβο<br/>
            • <span class="tag label-insufficient">insufficient_tasks</span> ο subject έχει <b>&lt;2 tasks</b>, άρα δεν μπορεί να γίνει cross-task audit
          </p>
        </div>

        <table id="ctbl">
          <thead>
            <tr>
              <th data-ck="subject_id">Subject</th>
              <th data-ck="label">Label</th>
              <th data-ck="tasks_available">Tasks</th>
              <th data-ck="confidence">Confidence</th>
              <th data-ck="dominant_families">Dominant families</th>
              <th data-ck="supporting_tasks">Supporting tasks</th>
              <th data-ck="note">Note</th>
              <th data-ck="action">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="small" style="margin-top:10px">
          Tip: Click <span class="mono">Focus</span> to automatically filter the per-task table by this subject id.
          <span class="small">Subjects with <span class="mono">insufficient_tasks</span> are shown but cannot be audited cross-task.</span>
        </div>
      </div>

    </div>
  </div>

  <footer>
    <div>
      Created by <strong>Dr. Georgios Bouchouras</strong> ·
      <a href="mailto:gbouchouras@mitropolitiko.edu.gr">gbouchouras@mitropolitiko.edu.gr</a>
    </div>
    <div class="affiliation">
      Center of Interdisciplinary Education and Research in Rehabilitation<br/>
      Metropolitan College, Thessaloniki
    </div>
  </footer>

<script>
  const el = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // ROBUST CSV PARSER (handles quoted commas + escaped quotes, single-line rows)
  function parseCSVRobust(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if(inQuotes){
        if(ch === '"' && next === '"'){ cur += '"'; i++; }
        else if(ch === '"'){ inQuotes = false; }
        else cur += ch;
      } else {
        if(ch === '"') inQuotes = true;
        else if(ch === ','){ row.push(cur); cur=""; }
        else if(ch === '\n'){
          row.push(cur); rows.push(row);
          row=[]; cur="";
        } else if(ch === '\r'){
          // ignore
        } else cur += ch;
      }
    }
    // push last row even if empty last line
    row.push(cur);
    rows.push(row);

    // trim trailing empty rows
    return rows.filter(r => r.some(x => String(x||"").trim().length));
  }

  function parseCSV(text){
    const rows = parseCSVRobust(text);
    if(!rows.length) return [];
    const header = rows[0].map(h=>String(h||"").trim());
    const out = [];
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      if(!r || !r.length) continue;
      const obj = {};
      for(let j=0;j<header.length;j++){
        obj[header[j]] = String(r[j] ?? "").trim();
      }
      out.push(obj);
    }
    return out;
  }

  function cacheBust(path){
    const sep = path.includes("?") ? "&" : "?";
    return `${path}${sep}v=${Date.now()}`;
  }

  async function fetchText(path){
    const r = await fetch(cacheBust(path), {cache:"no-store"});
    if(!r.ok) throw new Error(`Failed to fetch ${path} (${r.status})`);
    return await r.text();
  }

  function toNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function renderExplanation(text){
    if(!text) return `<span class="small err">No explanation</span>`;
    const safe = escapeHtml(text);
    if(safe.length <= 160) return `<span>${safe}</span>`;
    return `
      <details>
        <summary>Show</summary>
        <div class="small">${safe}</div>
      </details>
    `;
  }

  function toCSV(rows, cols){
    const esc = (v)=>{
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    };
    let out = cols.join(",") + "\n";
    for(const r of rows){
      out += cols.map(c=>esc(r[c])).join(",") + "\n";
    }
    return out;
  }

  // =========================
  // Per-task state + logic
  // =========================

  function normalizeRows(scoreRows, explRows){
    const explByPath = new Map();
    explRows.forEach(r=>{
      const p = r.path || r.file || r.trial || r.trial_path || "";
      if(!p) return;
      const exp = r.explanation || r.reason || r.summary || r.llm_explanation || "";
      explByPath.set(p, exp);
    });

    const rows = scoreRows.map(r=>{
      const path = r.path;
      return {
        rank: 0,
        path,
        subject_id: r.subject_id ?? r.subject ?? r.subj ?? "",
        label: r.label ?? "",
        mahalanobis_sq: toNum(r.mahalanobis_sq) ?? toNum(r.mahalanobis2) ?? null,
        score01: toNum(r.score01) ?? null,
        explanation: explByPath.get(path) || ""
      };
    });

    rows.sort((a,b)=>
      (b.mahalanobis_sq ?? -1) - (a.mahalanobis_sq ?? -1) ||
      (b.score01 ?? -1) - (a.score01 ?? -1)
    );
    rows.forEach((r,i)=> r.rank = i+1);
    return rows;
  }

  let STATE = {rows:[], sortKey:"rank", sortAsc:true};

  function render(){
    const tbody = el("tbl").querySelector("tbody");
    tbody.innerHTML = "";

    const q = el("q").value.trim().toLowerCase();
    const topn = Number(el("topn").value);

    let rows = STATE.rows.slice(0);
    if(q){
      rows = rows.filter(r =>
        String(r.subject_id).toLowerCase().includes(q) ||
        String(r.path).toLowerCase().includes(q)
      );
    }

    const k = STATE.sortKey;
    const asc = STATE.sortAsc;
    rows.sort((a,b)=>{
      const av=a[k], bv=b[k];
      const an = (typeof av==="number") ? av : toNum(av);
      const bn = (typeof bv==="number") ? bv : toNum(bv);
      let cmp = 0;
      if(an!==null && bn!==null) cmp = an - bn;
      else cmp = String(av??"").localeCompare(String(bv??""));
      return asc ? cmp : -cmp;
    });

    const shown = rows.slice(0, topn);
    shown.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.rank}</td>
        <td>${r.score01 ?? ""}</td>
        <td>${r.mahalanobis_sq ?? ""}</td>
        <td>${escapeHtml(r.subject_id ?? "")}</td>
        <td class="mono">${escapeHtml(r.path ?? "")}</td>
        <td>${renderExplanation(r.explanation)}</td>
      `;
      tbody.appendChild(tr);
    });

    el("filesBadge").textContent = `rows: ${STATE.rows.length} | showing: ${shown.length}`;
    const s = STATE.rows.map(r=>r.score01).filter(v=>typeof v==="number");
    if(s.length){
      const min=Math.min(...s), max=Math.max(...s);
      el("rangeBadge").textContent = `score01: ${min.toFixed(3)} → ${max.toFixed(3)}`;
    } else {
      el("rangeBadge").textContent = `score01: —`;
    }

    const cols = ["rank","score01","mahalanobis_sq","subject_id","path","explanation"];
    const csv = toCSV(shown, cols);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = el("download");
    a.href = url;
    a.download = `${el("task").value}_top${topn}_anomalies.csv`;
  }

  async function load(){
    const task = el("task").value;
    const scoresPath = `outputs/${task}_anomaly_scores.csv`;
    const explPath   = `outputs/${task}_anomaly_explanations.csv`;

    el("status").innerHTML = `<span class="small">Loading…</span>`;
    try{
      const [scoresTxt, explTxt] = await Promise.all([
        fetchText(scoresPath),
        fetchText(explPath).catch(()=> "")
      ]);

      const scoreRows = parseCSV(scoresTxt);
      const explRows  = explTxt ? parseCSV(explTxt) : [];

      STATE.rows = normalizeRows(scoreRows, explRows);
      el("status").innerHTML = `<span class="small ok">Loaded ${STATE.rows.length} rows for task=${escapeHtml(task)}.</span>`;
      render();
    }catch(e){
      el("status").innerHTML = `<span class="small err">${escapeHtml(e.message)}</span>`;
      STATE.rows = [];
      render();
    }
  }

  document.querySelectorAll("th[data-k]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const k = th.getAttribute("data-k");
      if(STATE.sortKey === k) STATE.sortAsc = !STATE.sortAsc;
      else { STATE.sortKey = k; STATE.sortAsc = true; }
      render();
    });
  });

  el("reload").addEventListener("click", load);
  el("task").addEventListener("change", load);
  el("topn").addEventListener("change", render);
  el("q").addEventListener("input", render);

  // =========================
  // Consistency state + logic
  // =========================

  let CSTATE = {rows:[], sortKey:"subject_id", sortAsc:true, hasNewSchema:false};

  function tryParseJsonArray(s){
    if(!s) return [];
    const t = String(s).trim();
    try{
      const arr = JSON.parse(t);
      return Array.isArray(arr) ? arr : [];
    }catch(_){
      if(!t) return [];
      if(t.includes("|")) return t.split("|").map(x=>x.trim()).filter(Boolean);
      if(t.includes(";")) return t.split(";").map(x=>x.trim()).filter(Boolean);
      if(t.includes(",")) return t.split(",").map(x=>x.trim()).filter(Boolean);
      return [t];
    }
  }

  function labelTag(label){
    const l = String(label || "").toLowerCase();
    let cls = "tag";
    if(l === "task_invariant") cls += " label-invariant";
    else if(l === "task_specific") cls += " label-specific";
    else if(l === "inconsistent") cls += " label-inconsistent";
    else if(l === "insufficient_tasks") cls += " label-insufficient";
    return `<span class="${cls}">${escapeHtml(label || "")}</span>`;
  }

  function passesLabelFilter(r){
    const want = (el("clabel")?.value || "all").toLowerCase();
    if(want === "all") return true;
    return String(r.label || "").toLowerCase() === want;
  }

  function renderC(){
    const tbody = el("ctbl").querySelector("tbody");
    tbody.innerHTML = "";

    const q = el("cq").value.trim().toLowerCase();
    const limit = Number(el("climit").value);

    let rows = CSTATE.rows.slice(0);

    // search filter
    if(q){
      rows = rows.filter(r => String(r.subject_id).toLowerCase().includes(q));
    }

    // label filter
    rows = rows.filter(passesLabelFilter);

    // sort
    const k = CSTATE.sortKey;
    const asc = CSTATE.sortAsc;
    rows.sort((a,b)=>{
      const av=a[k], bv=b[k];
      const an = toNum(av), bn = toNum(bv);
      let cmp = 0;
      if(an!==null && bn!==null) cmp = an - bn;
      else cmp = String(av??"").localeCompare(String(bv??""));
      return asc ? cmp : -cmp;
    });

    const shown = rows.slice(0, limit);
    shown.forEach(r=>{
      const fams = tryParseJsonArray(r.dominant_families);
      const tasks = tryParseJsonArray(r.supporting_tasks);

      const isInsufficient = String(r.label||"").toLowerCase() === "insufficient_tasks";
      const tasksAvail = r.tasks_available ?? "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.subject_id ?? "")}</td>
        <td>${labelTag(r.label)}</td>
        <td>${escapeHtml(tasksAvail)}</td>
        <td>${escapeHtml(r.confidence ?? "")}</td>
        <td>${fams.map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join("") || `<span class="small err">—</span>`}</td>
        <td>${tasks.map(x=>`<span class="tag">${escapeHtml(x)}</span>`).join("") || `<span class="small err">—</span>`}</td>
        <td>${isInsufficient ? `<span class="small">${escapeHtml(r.note || "")}</span>` : `<span class="small">—</span>`}</td>
        <td>
          <button class="focusBtn" data-subj="${escapeHtml(r.subject_id ?? "")}" ${isInsufficient ? "disabled" : ""}>
            Focus
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    el("cfilesBadge").textContent = `rows: ${CSTATE.rows.length} | filtered: ${rows.length} | showing: ${shown.length}`;

    // download current view
    const colsNew = ["subject_id","tasks_available","label","confidence","supporting_tasks","dominant_families","note","error"];
    const colsOld = ["subject_id","label","confidence","supporting_tasks","dominant_families","error"];
    const cols = CSTATE.hasNewSchema ? colsNew : colsOld;

    const csv = toCSV(shown, cols);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = el("cdownload");
    a.href = url;
    a.download = `consistency_labels_${el("clabel").value || "all"}_top${limit}.csv`;

    // bind focus buttons
    document.querySelectorAll(".focusBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(btn.disabled) return;
        const sid = btn.getAttribute("data-subj") || "";
        el("q").value = sid;
        render();
        window.scrollTo({top: 0, behavior: "smooth"});
      });
    });
  }

  async function loadConsistency(){
    const path = "outputs/consistency_labels.csv";
    el("cstatus").innerHTML = `<span class="small">Loading…</span>`;
    try{
      const txt = await fetchText(path);
      const rows = parseCSV(txt);

      // schema detection
      CSTATE.hasNewSchema = rows.length ? Object.prototype.hasOwnProperty.call(rows[0], "tasks_available") : false;

      // tolerant mapping
      CSTATE.rows = rows.map(r=>({
        subject_id: r.subject_id ?? r.subject ?? r.subj ?? "",
        tasks_available: r.tasks_available ?? "",
        label: r.label ?? "",
        confidence: r.confidence ?? "",
        dominant_families: r.dominant_families ?? r.families ?? "",
        supporting_tasks: r.supporting_tasks ?? r.tasks ?? "",
        note: r.note ?? "",
        error: r.error ?? ""
      }));

      el("cstatus").innerHTML = `<span class="small ok">Loaded ${CSTATE.rows.length} subjects.</span>`;
      renderC();
    }catch(e){
      el("cstatus").innerHTML = `<span class="small err">${escapeHtml(e.message)}</span>`;
      CSTATE.rows = [];
      renderC();
    }
  }

  document.querySelectorAll("th[data-ck]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const k = th.getAttribute("data-ck");
      if(CSTATE.sortKey === k) CSTATE.sortAsc = !CSTATE.sortAsc;
      else { CSTATE.sortKey = k; CSTATE.sortAsc = true; }
      renderC();
    });
  });

  el("creload").addEventListener("click", loadConsistency);
  el("cq").addEventListener("input", renderC);
  el("climit").addEventListener("change", renderC);
  el("clabel").addEventListener("change", renderC);

  // Initial loads
  load();
  loadConsistency();
</script>

</body>
</html>