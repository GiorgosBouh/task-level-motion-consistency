import os
import numpy as np
import pandas as pd

# ============================
# CONFIG
# ============================
DATA_DIR = "data"   # relative to repo root
FPS = 30.0
NORM_FRAMES = 100

# ============================
# JOINT DEFINITIONS
# ============================
JOINTS = [
    "SpineBase","SpineMid","Neck","Head",
    "ShoulderLeft","ElbowLeft","WristLeft","HandLeft",
    "ShoulderRight","ElbowRight","WristRight","HandRight",
    "HipLeft","KneeLeft","AnkleLeft","FootLeft",
    "HipRight","KneeRight","AnkleRight","FootRight",
    "SpineShoulder","HandTipLeft","ThumbLeft",
    "HandTipRight","ThumbRight"
]
J2I = {j: i for i, j in enumerate(JOINTS)}

# ============================
# IO
# ============================
def load_txt(path):
    data = np.loadtxt(path, delimiter=",")
    return data.reshape(data.shape[0], 25, 3)

# ============================
# PREPROCESSING
# ============================
def normalize_root(X):
    root = X[:, J2I["SpineBase"], :]
    return X - root[:, None, :]

def time_normalize(X, n=NORM_FRAMES):
    T = X.shape[0]
    t_old = np.linspace(0, 1, T)
    t_new = np.linspace(0, 1, n)
    Xn = np.zeros((n, 25, 3))
    for j in range(25):
        for a in range(3):
            Xn[:, j, a] = np.interp(t_new, t_old, X[:, j, a])
    return Xn

# ============================
# METRICS
# ============================
def speed(traj):
    v = np.diff(traj, axis=0) * FPS
    return np.linalg.norm(v, axis=1)

def normalized_jerk(traj):
    dt = 1 / FPS
    v = np.diff(traj, axis=0) / dt
    a = np.diff(v, axis=0) / dt
    j = np.diff(a, axis=0) / dt
    duration = traj.shape[0] * dt
    path = np.sum(np.linalg.norm(np.diff(traj, axis=0), axis=1))
    return (duration**5 * np.sum(j**2)) / (path**2 + 1e-6)

# ============================
# MAIN FEATURE EXTRACTION
# ============================
def extract_features(path):
    fname = os.path.basename(path)
    parts = fname.replace(".txt", "").split("_")

    X = load_txt(path)
    X = normalize_root(X)
    X = time_normalize(X)

    hand = X[:, J2I["HandRight"], :]
    trunk = X[:, J2I["SpineShoulder"], :]
    rel = hand - trunk

    feats = {
        "file": fname,
        "position": parts[-1],
        "gesture": int(parts[2]),
        "hand_displacement": np.linalg.norm(rel[-1] - rel[0]),
        "hand_path_length": np.sum(np.linalg.norm(np.diff(rel, axis=0), axis=1)),
        "hand_peak_speed": np.max(speed(rel)),
        "hand_mean_speed": np.mean(speed(rel)),
        "hand_smoothness": normalized_jerk(rel),
        "hand_variability": np.std(np.linalg.norm(rel, axis=1))
    }
    return feats

# ============================
# RUN PIPELINE
# ============================
all_files = [
    os.path.join(DATA_DIR, f)
    for f in os.listdir(DATA_DIR)
    if f.endswith(".txt")
]

results = [extract_features(f) for f in all_files]
df = pd.DataFrame(results)

print(df.sort_values(["gesture", "position"]).to_string(index=False))